#!/usr/bin/env bash

# Simple script for getting URL of current commit

GIT_REMOTE_URL=$(git config --get remote.origin.url)

if [[ "${GIT_REMOTE_URL}" != *github.com* ]]; then
    echo "Not a GitHub Origin!"
    exit 1
fi

TARGET="${1}"
shift
if [[ "${1}" == "-m" ]]; then
    SHOW_MESSAGE=1
    shift
fi

GIT_COMMIT=$(git rev-parse ${TARGET:-HEAD})
GIT_MESSAGE=$(git show --pretty=format:%s -s ${TARGET:-HEAD})

GITHUB_URL="${GIT_REMOTE_URL#git@github.com:}"
GITHUB_URL="${GITHUB_URL#https://github.com/}"
REPO_NAME="${GITHUB_URL%.git}"
# Use only the first 8 characters of Git SHA1
COMMIT_URL="https://github.com/${REPO_NAME}/commit/${GIT_COMMIT::8}"

RVAL="${COMMIT_URL}"
if [[ "${SHOW_MESSAGE}" ]]; then
    RVAL+=" - ${GIT_MESSAGE}"
fi

echo -n "${RVAL}"
echo -n "${RVAL}" | xsel -i --primary
echo -n "${RVAL}" | xsel -i --clipboard
