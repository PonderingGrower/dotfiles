#!/usr/bin/env bash

# force overriding files
if [[ $1 == '-f' ]]; then
    FORCE=1
    echo 'FORCE'
fi


# Find location of repo
SCRIPT_DIR=$(dirname $(readlink -f "$0"))
cd "$SCRIPT_DIR"
GIT_ROOT=$(git rev-parse --show-toplevel)
cd - > /dev/null

# Find files to symlink
CONFIG_FILES=$(find $GIT_ROOT -maxdepth 1 -type f -name '.*')
CONFIG_FILES+=$(find $GIT_ROOT/.config -maxdepth 1 | sed 1d)

for CONFIG_FILE in ${CONFIG_FILES}; do
    SOURCE="${GIT_ROOT}/${CONFIG_FILE}" 
    DEST="${HOME}/${CONFIG_FILE}"
    DEST_DIR=$(dirname "${DEST}")
    if [[ ! -d "${DEST_DIR}" ]]; then
        mkdir -p "${DEST_DIR}"
    fi
    if [[ ! ${FORCE} && -f "${DEST}" ]]; then
        echo "IS_FILE: ${DEST}"
    elif [[ ! ${FORCE} && -h "${DEST}" ]]; then
        echo "SYMLINK: ${DEST}"
    else
        echo "LINKING: ${SOURCE} -> ${DEST}"
        ln -sf "${SOURCE}" "${DEST}"
    fi
done
